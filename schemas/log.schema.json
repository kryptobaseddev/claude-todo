{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "claude-todo-log-schema-v2.1",
  "title": "CLAUDE-TODO Change Log Schema",
  "description": "Immutable audit trail of all task operations. Used for debugging, history, and anti-hallucination verification.",
  "type": "object",
  "required": ["version", "project", "entries", "_meta"],
  "additionalProperties": false,

  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version."
    },
    "project": {
      "type": "string",
      "description": "Project identifier. Must match todo.json."
    },
    "_meta": {
      "type": "object",
      "required": ["totalEntries", "firstEntry", "lastEntry"],
      "additionalProperties": false,
      "properties": {
        "formatVersion": {
          "type": "string",
          "pattern": "^\\d+$",
          "default": "1",
          "description": "Log entry format version for future compatibility. Increment when entry structure changes."
        },
        "totalEntries": {
          "type": "integer",
          "minimum": 0
        },
        "firstEntry": {
          "type": ["string", "null"],
          "format": "date-time"
        },
        "lastEntry": {
          "type": ["string", "null"],
          "format": "date-time"
        },
        "entriesPruned": {
          "type": "integer",
          "default": 0,
          "description": "Count of entries removed due to retention policy."
        }
      }
    },
    "entries": {
      "type": "array",
      "description": "Log entries in chronological order. Append-only.",
      "items": { "$ref": "#/definitions/logEntry" }
    }
  },

  "definitions": {
    "logEntry": {
      "type": "object",
      "required": ["id", "timestamp", "action", "actor"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^log_[a-f0-9]{12}$",
          "description": "Unique log entry ID. Format: log_<12-hex-chars>"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When this action occurred."
        },
        "sessionId": {
          "type": ["string", "null"],
          "description": "Session that performed this action."
        },
        "action": {
          "type": "string",
          "enum": [
            "session_start",
            "session_end",
            "task_created",
            "task_updated",
            "status_changed",
            "task_archived",
            "focus_changed",
            "config_changed",
            "validation_run",
            "checksum_updated",
            "error_occurred",
            "phase_changed",
            "phase_started",
            "phase_completed",
            "phase_rollback"
          ],
          "description": "Type of action logged. Phase actions: phase_changed (project phase modified), phase_started (phase activated), phase_completed (phase marked complete), phase_rollback (reverted to previous phase)."
        },
        "actor": {
          "type": "string",
          "enum": ["human", "claude", "system"],
          "description": "Who/what performed the action."
        },
        "taskId": {
          "type": ["string", "null"],
          "pattern": "^T\\d{3,}$",
          "description": "Task ID if action relates to a specific task."
        },
        "before": {
          "type": ["object", "null"],
          "description": "State before the action (for changes)."
        },
        "after": {
          "type": ["object", "null"],
          "description": "State after the action (for changes)."
        },
        "details": {
          "type": ["object", "string", "null"],
          "description": "Additional context about the action."
        },
        "error": {
          "type": ["object", "null"],
          "description": "Error details if action failed.",
          "properties": {
            "code": { "type": "string" },
            "message": { "type": "string" },
            "recoverable": { "type": "boolean" }
          }
        }
      }
    }
  }
}
